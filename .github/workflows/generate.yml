name: Generate
on:
  schedule:
    - cron:  '49 * * * *'
jobs:
  supported-versions-matrix:
    name: Supported Versions Matrix
    runs-on: ubuntu-latest
    outputs:
      lowest: ${{ steps.supported-versions-matrix.outputs.lowest }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - id: supported-versions-matrix
        uses: WyriHaximus/github-action-composer-php-versions-in-range@ea3d54bf7909d5607c4f32bda9cd8d64e420ec99 # v1
        with:
          upcomingReleases: true
  generate:
    name: Generate
    needs:
      - supported-versions-matrix
    runs-on: ubuntu-latest
    container:
      image: wyrihaximusnet/php:${{ needs.supported-versions-matrix.outputs.lowest }}-zts-alpine-dev-root
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
      - run: git config --global --add safe.directory $GITHUB_WORKSPACE # Do this ourself because `actions/checkout@v4 doesn't succeed in doing this
      - name: Install Dependencies
        run: composer install --ansi --no-progress --no-interaction --prefer-dist
      - name: Generate new version file
        id: generate
        run: php tools/generate.php
      - name: Test
        run: php tests/test.php
      - name: 'Get Previous tag'
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@master"
        env:
          GITHUB_TOKEN: "${{ secrets.AUTH_TOKEN }}"
      - name: 'Get files changed since previous tag'
        id: fileschangedsinceprevioustag
        uses: "WyriHaximus/github-action-files-in-commit@master"
        with:
          baseSha: ${{ steps.previoustag.outputs.tag }}
          headSha: HEAD
        env:
          GITHUB_TOKEN: "${{ secrets.AUTH_TOKEN }}"
      - name: 'Get next minor version'
        id: semvers
        if: steps.fileschangedsinceprevioustag.outputs.files == ''
        uses: "WyriHaximus/github-action-next-semvers@master"
        with:
          version: ${{ steps.previoustag.outputs.tag }}
      - name: 'Create new milestone'
        id: createmilestone
        if: steps.fileschangedsinceprevioustag.outputs.files == ''
        uses: "WyriHaximus/github-action-create-milestone@master"
        with:
          title: ${{ steps.semvers.outputs.patch }}
          description: ${{ env.PULL_REQUEST_BODY }}
        env:
          GITHUB_TOKEN: "${{ secrets.AUTH_TOKEN }}"
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ secrets.AUTH_TOKEN }}
          labels: |
            Automated PR
            New Version
            automerge
          title: "[New Version] Update versions file to PHP ${{ steps.generate.outputs.actual }}"
          body: "With the release of PHP ${{ steps.generate.outputs.actual }} this packages needs updating. So this PR will bump current to ${{ steps.generate.outputs.current }} and future to ${{ steps.generate.outputs.future }}."
          milestone: ${{ steps.createmilestone.outputs.number }}
